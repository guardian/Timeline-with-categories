<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Timeline | The Guardian</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"> 
		<link rel="stylesheet" type="text/css" href="css/timeline.css" />

		<!--[if lt IE 9]>
		<script src="http://css3-mediaqueries-js.googlecode.com/files/css3-mediaqueries.js"></script>
		<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->

	</head>
	<body>
		
		<div id="timeline" class="timeline-container">
		<div id="nav" class="navbar" >	
			<div class="nav-categories">
					<ul id="category-menu" class="clearfix">
				    </ul>

			</div>
			<div id="nav-buttons">
				<span class="glyphicon glyphicon-plus-sign" id="expandAll" title="Expand or minimise all"></span>
			</div>	 
			<div class="clearfix"></div>
		</div>	

		<div class="timeline-main">
	 
				<ul class="cbp_tmtimeline" id="timeline-list">
				</ul>
				
		</div>
		<div id="footer"></div>
		</div>
		<script type="text/javascript" src="js/d3.min.js"></script>	
		<script type="text/javascript" src="js/jquery-1.11.1.min.js"></script>	
		<script src="http://interactive.guim.co.uk/libs/iframe-messenger/iframeMessenger.js" type="text/javascript"></script>
		<script type="text/javascript">
		iframeMessenger.enableAutoResize();

		function initTimeline() {

			//get spreadsheet key from embed url

			var key = getParameter( "key");
    		var url = "http://interactive.guim.co.uk/docsdata/" + key + ".json";

    		console.log(key,url);

    		$.getJSON(url, function(data) {

		    dataset = data.sheets.Sheet1;
		    buildTimeline(dataset);

    		});

    		}

    		function buildTimeline(data) {

    			console.log(data);

    			//Make list of categories

    			var catListTemp = d3.nest()
						.key(function(d){ return d.category})
						.entries(data);

				var catList = [];			

				catListTemp.forEach(function(d) {	
					catList.push(d.key);
				});		

				console.log("catList",catList);

				$('#category-menu').append('<li class="current">Categories</li>');

				catList.forEach(function(cat,i) {

					$('#category-menu').append(
						'<li class="category"><a href="#" data-cat="' +
						cat.replace(/ /g,"_") +
						'" class="' +
						cat.replace(/ /g,"_") +
						' cat' + i + 
						'">' +
						cat +
						'</li>'
						);

				})

    			for (var i = 0; i < data.length; i++) {

    				currCat = data[i]['category'];
    				console.log(catList.indexOf(currCat));

					$('#timeline-list').append(
						'<li class="incident ' 
						+ data[i]['category'].replace(/ /g,"_") + ' cat' + catList.indexOf(data[i]['category'])
						+ '" id="timeline-entry' 
						+ (i + 1) 
						+ '"><time class="cbp_tmtime" datetime="' 
						+ data[i]['date'] 
						+ '"><span>' 
						+ data[i]['date'] 
						+ '</span><span>' 
						+ '</time>' 
						+ '<div class="cbp_tmicon cbp_tmicon-phone"></div><div class="cbp_tmlabel"><span class="manusupdate">' 
						+ data[i]['kicker'] 
						+ '</span><h2 data-incident="timeline-entry' 
						+ (i + 1) + '">' 
						+ data[i]['title'] 
						+ '</h2><div class="details"><p>' 
						+ data[i]['text'] 
						+ '</p><p>'
						+ '<span class="update">Source: '
						+ '<a href="' 
						+ data[i]['link'] 
						+ '" target="_blank">' 
						+ data[i]['source'] 
						+ '</a></span><br>'
						+ '</p></div></div></li>')

				}

				//Listeners

				var expanded = "no";

				$(".incident h2").click(function() {

					var currInc = $(this).attr('data-incident');
			
					if ($("#" + currInc + " .details").is(':visible')) {
						$("#" + currInc + " .details").slideUp();
						$("#" + currInc + " h2").css("background-image", "url(img/down.png)"); 
					}

					else if ($("#" + currInc + " .details").is(':hidden')) {
						$("#" + currInc + " .details").slideDown();
						$("#" + currInc + " h2").css("background-image", "url(img/up.png)"); 
					}
					
			    });

			    $(".category a").click(function() {

					var catID = $(this).data('cat');
					console.log(catID);
					
					if (catID != 'showall') {

						iframeMessenger.scrollTo(0,initialOffset);
						$('#nav').animate({top: '0px'}, 100);

						catList.forEach(function(cat) {
						if (cat.replace(/ /g,"_") != catID) {

							$("#timeline-list ." + cat.replace(/ /g,"_")).fadeOut();
						}
						});

						$("#timeline-list ." + catID).fadeIn();
					} 

					else if (catID === 'showall') {
						catList.forEach(function(cat) {
							$("#timeline-list ." + cat.replace(/ /g,"_")).fadeIn();
						});


					}
									

				});

				$("#expandAll").click(function() {

					if (expanded == True) {
					$(".details").slideDown();
					$("#expandAll").removeClass("glyphicon-plus-sign");
					$("#expandAll").addClass("glyphicon-minus-sign");

					expanded = "yes";
					$("#timeline-list h2").css("background-image", "url(img/up.png)"); 

					}

					else if (expanded == "yes") {
						$(".details").slideUp();
						$("#expandAll").addClass("glyphicon-plus-sign");
						$("#expandAll").removeClass("glyphicon-minus-sign");
						expanded = "no";
						$("#timeline-list h2").css("background-image", "url(img/down.png)"); 

					}

				});

				$(".current").click(function(){

					getW = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);

					if ($(".category").is(':visible')) {
						$(".category").hide();
					}

					else if ($(".category").is(':hidden')) {
						$(".category").show();
						if (getW > 601) {

						$(".nav-categories li").css("display", "inline-block");
						
						}
					}
					
					
				});

				//Sticky nav within iframe

			    var initialOffset;

				iframeMessenger.getPositionInformation(function(data) {
							initialOffset = data['iframeTop'];
						});

				if (window!=window.top) { 
				
					setInterval(function(){

						iframeMessenger.getPositionInformation(function(data) {
							var endPoint = $("#footer").position().top
					        console.log("pageYOffSet", data['pageYOffset'], "iframeTop", data['iframeTop'], "innerHeight", data['innerHeight']);
					        if (data['iframeTop'] < 0 && data['iframeTop'] > (-1*(endPoint-70))) {

					        	$('#nav').animate({top: -1*data['iframeTop'] + 'px'}, 100)
	
					        }

					        else if (data['iframeTop'] > 0) {
					        	$('#nav').animate({top: '0px'}, 100)

					        }
					    });

					}, 200);

				}
				
				if( !/iPhone|iPad|iPod/i.test(navigator.userAgent) ) {

				$(window).resize(function() {

				getW = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);

				if (getW > 601) {

					if ($(".category").is(':hidden')) {
						$(".category").show();
						$(".nav-categories li").css("display", "inline-block");
					}
				 
				}


				if (getW < 600) {

					$(".nav-categories li").css("display", "block");

					if ($(".category").is(':visible')) {
						$(".category").hide();
						
					}

				}

				});


				}

    	}


		//end initTimeline

		function getParameter(paramName) {
		  var searchString = window.location.search.substring(1),
		      i, val, params = searchString.split("&");

		  for (i=0;i<params.length;i++) {
		    val = params[i].split("=");
		    if (val[0] == paramName) {
		      return val[1];
		    }
		  }
		  return null;
		}

		initTimeline();




	</script>	

	</body>

</html>
